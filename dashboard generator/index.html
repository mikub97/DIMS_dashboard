<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DIMS Dashboard Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { height: 100vh; overflow: hidden; }
    #fileOverview { overflow-y: auto; max-height: calc(100vh - 40px); }
    .group-box { border: 1px solid #ccc; border-radius: 4px; padding: 10px; margin-bottom: 10px; background: #fff; }
    .sortable-item { cursor: grab; }
    .group-header { display: flex; justify-content: space-between; align-items: center; }
    .missing { background-color: #fff3cd; }
  </style>
</head>
<body class="bg-light">
  <div class="container-fluid h-100">
    <div class="row h-100">

      <!-- Left Pane: Controls -->
      <div class="col-md-6 p-4 bg-white border-end">
        <h2 class="mb-4">DIMS Dashboard Builder</h2>

        <div class="mb-3">
          <label class="form-label">Add Videos (.mp4)</label>
          <button class="btn btn-primary w-100" id="selectVideos">Select Video Files</button>
        </div>

        <div class="mb-3">
          <label class="form-label">Add Timeseries CSVs</label>
          <button class="btn btn-primary w-100" id="selectCSVs">Select CSV Files</button>
        </div>

        <div class="mb-3">
          <label class="form-label">Add Transcripts (JSON)</label>
          <button class="btn btn-primary w-100" id="selectTranscripts">Select Transcript Files</button>
        </div>

        <div class="mb-3">
          <label class="form-label">Config File Path (config.json)</label>
          <input type="text" class="form-control" id="configPath" placeholder="Path to config.json">
        </div>

        <div class="mb-4 d-flex gap-2">
          <button class="btn btn-secondary" id="generateConfig">Generate config.json</button>
          <button class="btn btn-success" id="runRQA">Run RQA Processing</button>
        </div>

        <div class="mb-3">
          <label class="form-label">Script Output</label>
          <pre id="rqaOutput" class="bg-light p-3 border rounded" style="min-height: 100px;"></pre>
        </div>
      </div>

      <!-- Right Pane: File Overview -->
      <div class="col-md-6 p-4 bg-light" id="fileOverview">
        <h4>Loaded Data</h4>
        <div class="mb-3">
          <button class="btn btn-outline-secondary w-100" onclick="createNewGroup()">+ Add New Group</button>
        </div>
        <div id="groupedFileList" class="mt-3"></div>
      </div>

    </div>
  </div>

<script>
  const { ipcRenderer } = require('electron');
  const fileGroups = {};
  let selectedGroupId = null;

  function extractVideoID(filename) {
    const match = filename.match(/(\d+)/);
    return match ? match[1] : null;
  }

  function createNewGroup(defaultId = null) {
    const newId = defaultId || `group_${Date.now()}`;
    if (!fileGroups[newId]) fileGroups[newId] = { video: null, transcript: null, csv: [] };
    selectedGroupId = newId;
    renderFileGroups();
  }

  function deleteGroup(id) {
    delete fileGroups[id];
    if (selectedGroupId === id) selectedGroupId = null;
    renderFileGroups();
  }

  function setActiveGroup(id) {
    selectedGroupId = id;
    renderFileGroups();
  }

  function renderFileGroups() {
    const container = document.getElementById('groupedFileList');
    container.innerHTML = '';

    Object.entries(fileGroups).forEach(([id, group]) => {
      const section = document.createElement('div');
      section.className = 'group-box' + (id === selectedGroupId ? ' border-primary' : '');

      const groupId = `sortable-${id}`;
      const missingVideo = !group.video ? 'missing' : '';
      const missingTranscript = !group.transcript ? 'missing' : '';

      section.innerHTML = `
        <div class="group-header">
          <h5 contenteditable="true" class="group-title" onblur="updateGroupId(this, '${id}')">${id}</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-info" onclick="setActiveGroup('${id}')">Select</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup('${id}')">Delete</button>
          </div>
        </div>
        <div class="${missingVideo}"><strong>Video:</strong>
          <ul class="sortable list-group" id="video-${id}">
            ${group.video ? `<li class="sortable-item list-group-item">${group.video}</li>` : '<li class="list-group-item">[missing]</li>'}
          </ul>
        </div>
        <div class="${missingTranscript}"><strong>Transcript:</strong>
          <ul class="sortable list-group" id="transcript-${id}">
            ${group.transcript ? `<li class="sortable-item list-group-item">${group.transcript}</li>` : '<li class="list-group-item">[missing]</li>'}
          </ul>
        </div>
        <div><strong>CSV:</strong>
          <ul class="sortable list-group" id="csv-${id}">
            ${group.csv.map(p => `<li class="sortable-item list-group-item">${p}</li>`).join('')}
          </ul>
        </div>
      `;

      container.appendChild(section);

      ['csv', 'video', 'transcript'].forEach(type => {
        new Sortable(section.querySelector(`#${type}-${id}`), {
          group: type + '-shared',
          animation: 150,
          ghostClass: 'bg-warning'
        });
      });
    });
  }

  function updateGroupId(el, oldId) {
    const newId = el.textContent.trim();
    if (newId && newId !== oldId && !fileGroups[newId]) {
      fileGroups[newId] = fileGroups[oldId];
      delete fileGroups[oldId];
      if (selectedGroupId === oldId) selectedGroupId = newId;
      renderFileGroups();
    } else {
      el.textContent = oldId;
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('selectVideos').addEventListener('click', async () => {
      if (!selectedGroupId) return alert('Please select a group first.');
      const paths = await ipcRenderer.invoke('select-file', [{ name: 'Videos', extensions: ['mp4'] }]);
      if (!Array.isArray(paths)) return;
      paths.forEach(p => {
        fileGroups[selectedGroupId].video = p;
      });
      renderFileGroups();
    });

    document.getElementById('selectCSVs').addEventListener('click', async () => {
      if (!selectedGroupId) return alert('Please select a group first.');
      const paths = await ipcRenderer.invoke('select-file', [{ name: 'CSV', extensions: ['csv'] }]);
      if (!Array.isArray(paths)) return;
      fileGroups[selectedGroupId].csv.push(...paths);
      renderFileGroups();
    });

    document.getElementById('selectTranscripts').addEventListener('click', async () => {
      if (!selectedGroupId) return alert('Please select a group first.');
      const paths = await ipcRenderer.invoke('select-file', [{ name: 'JSON', extensions: ['json'] }]);
      if (!Array.isArray(paths)) return;
      paths.forEach(p => {
        fileGroups[selectedGroupId].transcript = p;
      });
      renderFileGroups();
    });
  });
</script>
</body>
</html>
